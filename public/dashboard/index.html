<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>GPON Monitor â€¢ Live Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon"
    href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“Š</text></svg>">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sparkline@0.3.0/dist/sparkline.min.js"></script>

  <style>
    :root {
      --bg: #f5f7fa;
      --card: #ffffff;
      --text: #1a202c;
      --text-light: #718096;
      --primary: #4f46e5;
      --primary-light: #6366f1;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --border: #e2e8f0;
      --shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
      --ipv4-color: #4f46e5;
      --ipv6-color: #8b5cf6;
    }

    [data-theme="dark"] {
      --bg: #0f172a;
      --card: #1e293b;
      --text: #f1f5f9;
      --text-light: #94a3b8;
      --primary: #6366f1;
      --primary-light: #818cf8;
      --border: #334155;
      --ipv4-color: #818cf8;
      --ipv6-color: #c084fc;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.6;
    }

    .container {
      max-width: 1400px;
      padding: 24px;
      margin: 0 auto;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
      gap: 16px;
    }

    h1 {
      font-size: 32px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .controls {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-weight: 500;
      color: var(--text);
      background: var(--card);
      padding: 8px 16px;
      border-radius: 10px;
      border: 1px solid var(--border);
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s;
    }

    .user-info:hover {
      border-color: var(--primary);
      background: rgba(79, 70, 229, 0.05);
      transform: translateY(-1px);
    }

    .logout-btn {
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger);
      border: 1px solid rgba(239, 68, 68, 0.2);
    }

    .logout-btn:hover {
      background: var(--danger);
      color: white;
    }

    input,
    select,
    button {
      padding: 10px 16px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text);
      font-size: 14px;
      font-family: inherit;
      transition: all 0.2s;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    button {
      background: var(--primary);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }

    button:hover {
      background: var(--primary-light);
      transform: translateY(-1px);
    }

    #themeToggle {
      width: 44px;
      height: 44px;
      padding: 0;
      font-size: 20px;
      border-radius: 50%;
    }

    /* Stable Global Chart */
    .global-traffic {
      background: var(--card);
      padding: 20px;
      border-radius: 16px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      margin-bottom: 24px;
      height: 280px;
      display: flex;
      flex-direction: column;
    }

    .global-traffic h3 {
      font-size: 19px;
      font-weight: 600;
      margin-bottom: 12px;
      text-align: center;
      background: linear-gradient(135deg, var(--success), var(--primary));
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    #globalChart {
      flex: 1;
      width: 100% !important;
      height: 200px !important;
      max-height: 200px !important;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat {
      background: var(--card);
      padding: 24px;
      border-radius: 16px;
      box-shadow: var(--shadow);
      text-align: center;
      border: 1px solid var(--border);
    }

    .stat h3 {
      color: var(--text-light);
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .stat span {
      font-size: 36px;
      font-weight: 700;
      display: block;
    }

    .active span {
      color: var(--success);
    }

    .inactive span {
      color: var(--danger);
    }

    #saveStatus {
      margin: 16px 0;
      padding: 12px;
      border-radius: 10px;
      text-align: center;
      font-weight: 600;
      transition: all 0.3s;
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background: var(--card);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: var(--shadow);
      font-size: 14px;
      border: 1px solid var(--border);
    }

    th,
    td {
      padding: 16px 12px;
      text-align: left;
    }

    th {
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: white;
      font-weight: 600;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    tbody tr {
      border-bottom: 1px solid var(--border);
      transition: background 0.2s;
    }

    tbody tr:hover {
      background: rgba(79, 70, 229, 0.05);
    }

    tbody tr:last-child {
      border-bottom: none;
    }

    /* IP Column */
    th:nth-child(3),
    td:nth-child(3) {
      width: 130px;
      max-width: 130px;
      min-width: 110px;
      position: relative;
    }

    .ip-cell {
      font-family: 'Consolas', monospace;
      font-size: 13px;
      font-weight: 500;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      display: block;
      cursor: help;
    }

    .ip-cell.ipv4 {
      color: var(--ipv4-color);
    }

    .ip-cell.ipv6 {
      color: var(--ipv6-color);
    }

    .ip-cell:hover {
      overflow: visible;
      white-space: normal;
      word-wrap: break-word;
      background: var(--card);
      color: var(--text) !important;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.18);
      border-radius: 8px;
      padding: 10px 14px;
      z-index: 20;
      max-width: 280px;
      margin-left: -8px;
      margin-top: -6px;
      font-weight: 600;
      border: 1px solid var(--border);
    }

    tr.inactive {
      opacity: 0.5;
    }

    canvas.sparkline {
      width: 100% !important;
      height: 40px !important;
    }

    .view-btn {
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      border: none;
      cursor: pointer;
      padding: 8px 16px;
      color: white;
      border-radius: 8px;
      font-weight: 600;
      font-size: 12px;
    }

    .view-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4);
    }

    .threshold-badge {
      display: inline-block;
      padding: 6px 12px;
      background: linear-gradient(135deg, #f59e0b, #f97316);
      color: white;
      border-radius: 8px;
      font-weight: 600;
      font-size: 12px;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.75);
      z-index: 9999;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(10px);
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--card);
      border-radius: 24px;
      width: 95%;
      max-width: 1200px;
      max-height: 90vh;
      overflow: hidden;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      border: 1px solid var(--border);
    }

    .modal-header {
      padding: 24px 32px;
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h2 {
      font-size: 24px;
      font-weight: 700;
    }

    .close-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      width: 40px;
      height: 40px;
      border-radius: 50%;
    }

    .close-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: rotate(90deg);
    }

    .chart-container {
      padding: 32px;
      height: calc(90vh - 100px);
    }

    @media (max-width: 768px) {
      .container {
        padding: 16px;
      }

      h1 {
        font-size: 24px;
      }

      .stats {
        grid-template-columns: 1fr 1fr;
      }

      .global-traffic {
        height: 240px;
      }

      #globalChart {
        height: 160px !important;
      }

      .user-info span {
        display: none;
      }
    }

    /* Badge styles for non-admin users */
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .badge.active {
      background: rgba(16, 185, 129, 0.1);
      color: var(--success);
      border: 1px solid rgba(16, 185, 129, 0.2);
    }

    .badge.inactive {
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger);
      border: 1px solid rgba(239, 68, 68, 0.2);
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1>GPON Network Monitor</h1>
      <div class="controls">
        <a href="/profile" class="user-info" id="userInfo" style="display: none;">
          <span id="userNameDisplay">User</span>
        </a>
        <button id="logoutBtn" class="logout-btn" style="display: none;">Logout</button>
        <input type="text" id="search" placeholder="Search name or IP..." />
        <button id="themeToggle">ðŸŒ™</button>
      </div>
    </header>

    <div id="saveStatus"></div>

    <div class="global-traffic">
      <h3>Global Network Traffic (All ONTs Combined)</h3>
      <canvas id="globalChart"></canvas>
    </div>

    <div class="stats">
      <div class="stat active">
        <h3>Active</h3><span id="activeCount">0</span>
      </div>
      <div class="stat inactive">
        <h3>Inactive</h3><span id="inactiveCount">0</span>
      </div>
      <div class="stat">
        <h3>Total Queues</h3><span id="totalCount">0</span>
      </div>
      <div class="stat">
        <h3>Last Update</h3><span id="lastUpdate" style="font-size:20px;">--:--</span>
      </div>
    </div>

    <table id="gponTable">
      <thead>
        <tr>
          <th>#</th>
          <th>Name</th>
          <th>IP Address</th>
          <th>RX</th>
          <th>TX</th>
          <th>Traffic</th>
          <th>Threshold</th>
          <th>Status</th>
          <th>Chart</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="chartModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Traffic Chart</h2>
        <button class="close-btn">Ã—</button>
      </div>
      <div class="chart-container">
        <canvas id="trafficChart"></canvas>
      </div>
    </div>
  </div>

  <script>
    const API = `http://${window.location.hostname}:3000/api`;
    let data = [];
    let pendingUpdates = {};
    let saveTimeout = null;
    let chartInstance = null;
    let globalChart = null;
    let currentUser = null;
    const history = { time: [], rx: [], tx: [] };

    // Auth Check
    async function checkAuth() {
      try {
        const res = await fetch(`${API}/auth/me`);
        if (!res.ok) {
          window.location.href = '/login';
          return;
        }
        const { user } = await res.json();
        currentUser = user;
        document.getElementById('userNameDisplay').textContent = user.username;
        document.getElementById('userInfo').style.display = 'flex';
        document.getElementById('logoutBtn').style.display = 'block';

        // Show Admin Link if admin
        if (user.role === 'admin') {
          const adminLink = document.createElement('a');
          adminLink.href = '/admin';
          adminLink.textContent = 'Admin Panel';
          adminLink.style.cssText = 'color: var(--primary); font-weight: 600; text-decoration: none; margin-right: 12px;';
          document.querySelector('.controls').prepend(adminLink);
        }
      } catch (err) {
        window.location.href = '/login';
      }
    }
    checkAuth();

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      try {
        await fetch(`${API}/auth/logout`, { method: 'POST' });
        localStorage.removeItem('user');
        window.location.href = '/login';
      } catch (err) {
        console.error('Logout failed', err);
      }
    });

    // Theme
    const themeToggle = document.getElementById('themeToggle');
    const setTheme = dark => {
      document.documentElement.dataset.theme = dark ? 'dark' : '';
      themeToggle.textContent = dark ? 'â˜€ï¸' : 'ðŸŒ™';
      localStorage.setItem('theme', dark ? 'dark' : 'light');
    };
    themeToggle.addEventListener('click', () => setTheme(document.documentElement.dataset.theme !== 'dark'));
    if (localStorage.getItem('theme') === 'dark') setTheme(true);

    // Global Chart
    function initGlobalChart() {
      globalChart = new Chart(document.getElementById('globalChart'), {
        type: 'line',
        data: {
          labels: [], datasets: [
            { label: 'Total RX (MB/s)', data: [], borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,0.12)', tension: 0.4, fill: true },
            { label: 'Total TX (MB/s)', data: [], borderColor: '#4f46e5', backgroundColor: 'rgba(79,70,229,0.12)', tension: 0.4, fill: true }
          ]
        },
        options: { responsive: true, maintainAspectRatio: false, animation: false, plugins: { legend: { position: 'top' } }, scales: { y: { beginAtZero: true }, x: { display: false } } }
      });
    }

    function updateGlobalChart() {
      if (!globalChart || !data.length) return;
      const totalRx = data.reduce((a, b) => a + b.rx, 0) / 1e6;
      const totalTx = data.reduce((a, b) => a + b.tx, 0) / 1e6;
      const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

      history.time.push(time); history.rx.push(totalRx); history.tx.push(totalTx);
      if (history.time.length > 30) { history.time.shift(); history.rx.shift(); history.tx.shift(); }

      globalChart.data.labels = history.time;
      globalChart.data.datasets[0].data = history.rx;
      globalChart.data.datasets[1].data = history.tx;
      globalChart.update('none');
    }

    async function loadData() {
      try {
        const res = await fetch(`${API}/queues`, { cache: "no-store" });
        if (res.status === 401) { window.location.href = '/login'; return; }
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const json = await res.json();
        data = json.queues || json.data || [];
        if (!data.length) { showStatus("No ONTs found", "warning"); return; }
        render();
        updateGlobalChart();
        document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        clearStatus();
      } catch (err) {
        console.error("Load error:", err);
        showStatus("Connection failed â€“ Is backend running on port 3000?", "danger");
      }
    }

    function showStatus(msg, type = "danger") {
      const el = document.getElementById('saveStatus');
      el.textContent = msg;
      el.style.background = type === "danger" ? "rgba(239,68,68,0.1)" : "rgba(245,158,11,0.1)";
      el.style.color = type === "danger" ? "var(--danger)" : "var(--warning)";
    }
    function clearStatus() { document.getElementById('saveStatus').textContent = ''; }

    function render() {
      const tbody = document.querySelector('#gponTable tbody');
      const search = document.getElementById('search').value.toLowerCase();
      tbody.innerHTML = '';
      let active = 0, inactive = 0;

      const filtered = data.filter(q => q.name?.toLowerCase().includes(search) || q.ip?.toLowerCase().includes(search));

      filtered.forEach((q, i) => {
        if (q.status === 'Active') active++; else inactive++;
        const isIPv6 = q.ip.includes(':');
        const spark = Array.from({ length: 20 }, () => Math.max(0.1, (q.rx + q.tx) / 1e6 + Math.random() * 12));

        const isAdmin = currentUser && currentUser.role === 'admin';

        let statusHtml;
        if (isAdmin) {
          statusHtml = `<select class="status-select" data-name="${q.name}"><option value="Active" ${q.status === 'Active' ? 'selected' : ''}>Active</option><option value="Inactive" ${q.status === 'Inactive' ? 'selected' : ''}>Inactive</option></select>`;
        } else {
          statusHtml = `<span class="badge ${q.status.toLowerCase()}">${q.status}</span>`;
        }

        const tr = document.createElement('tr');
        if (q.status !== 'Active') tr.classList.add('inactive');
        tr.innerHTML = `
          <td class="row-number">${i + 1}</td>
          <td><strong>${q.name}</strong></td>
          <td class="ip-cell ${isIPv6 ? 'ipv6' : 'ipv4'}" title="${q.ip}">${q.ip}</td>
          <td>${(q.rx / 1e6).toFixed(2)}M</td>
          <td>${(q.tx / 1e6).toFixed(2)}M</td>
          <td>
            <div style="display:flex; flex-direction:column; gap:2px;">
              <span style="font-weight:600; font-size:12px;">Total: ${((q.rx + q.tx) / 1e6).toFixed(2)} M</span>
              <canvas class="sparkline" values="${spark.join(',')}"></canvas>
            </div>
          </td>
          <td><span class="threshold-badge">${q.threshold} KB/s</span></td>
          <td>${statusHtml}</td>
          <td style="text-align:center"><button class="view-btn" data-name="${q.name}">View</button></td>
        `;
        tbody.appendChild(tr);
      });

      document.getElementById('activeCount').textContent = active;
      document.getElementById('inactiveCount').textContent = inactive;
      document.getElementById('totalCount').textContent = filtered.length;

      bindEvents();
      setTimeout(renderSparklines, 50);
    }

    function renderSparklines() {
      document.querySelectorAll('.sparkline').forEach(c => {
        const v = c.getAttribute('values').split(',').map(Number);
        sparkline(c, v, { width: c.parentNode.offsetWidth, height: 40, lineColor: 'var(--primary)', fillColor: 'rgba(79,70,229,0.15)', endColor: 'var(--success)' });
      });
    }

    function bindEvents() {
      document.querySelectorAll('.status-select').forEach(s => s.onchange = scheduleSave);
      document.querySelectorAll('.view-btn').forEach(b => b.onclick = () => openChartModal(b.dataset.name));
    }

    function scheduleSave() {
      const name = this.dataset.name;
      pendingUpdates[name] = { status: this.value };
      showStatus("Saving...", "warning");
      clearTimeout(saveTimeout);
      saveTimeout = setTimeout(async () => {
        try {
          await fetch(`${API}/statuses/bulk`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(pendingUpdates) });
          pendingUpdates = {};
          showStatus("Saved successfully", "success");
          setTimeout(clearStatus, 2000);
        } catch { showStatus("Save failed", "danger"); }
      }, 800);
    }

    async function openChartModal(name) {
      document.getElementById('modalTitle').textContent = `${name} â€” Last 24 Hours`;
      document.getElementById('chartModal').classList.add('active');
      try {
        const res = await fetch(`${API}/traffic/${encodeURIComponent(name)}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const contentType = res.headers.get("content-type");
        if (!contentType || !contentType.includes("application/json")) {
          console.error("Expected JSON, got:", await res.text());
          throw new Error("Invalid response format");
        }

        const { data: points } = await res.json();
        const labels = points.map(p => new Date(p.time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }));
        const rx = points.map(p => p.rx); const tx = points.map(p => p.tx);
        if (chartInstance) chartInstance.destroy();
        chartInstance = new Chart(document.getElementById('trafficChart'), {
          type: 'line', data: {
            labels, datasets: [
              { label: 'RX (KB/s)', data: rx, borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,0.1)', tension: 0.4, fill: true },
              { label: 'TX (KB/s)', data: tx, borderColor: '#4f46e5', backgroundColor: 'rgba(79,70,229,0.1)', tension: 0.4, fill: true }
            ]
          }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } } }
        });
      } catch (e) {
        console.error(e);
        document.getElementById('modalTitle').textContent = 'No traffic data yet';
      }
    }

    document.querySelector('.close-btn').onclick = () => {
      document.getElementById('chartModal').classList.remove('active');
      if (chartInstance) { chartInstance.destroy(); chartInstance = null; }
    };
    document.getElementById('chartModal').onclick = e => { if (e.target === e.currentTarget) document.querySelector('.close-btn').click(); };
    document.getElementById('search').addEventListener('input', render);

    // Start
    initGlobalChart();
    loadData();
    setInterval(loadData, 12000);
  </script>
</body>

</html>